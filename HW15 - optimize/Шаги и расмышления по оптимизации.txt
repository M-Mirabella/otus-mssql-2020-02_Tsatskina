Предистория. Запросы выполняются в Sql Server 2012.
От функции stack.calc_contracts_accs(@dogs,@d1) отказаться нельзя и переписать ее нельзя, т.к. она от вендора. Из нее вызывается функция stack.contracts,
 из которой в свою очередь вызывается Stack.contracts_lite, которая разворачивает вертикальную иерархию по договорам. В качестве @dogs могут передать -10 - все договора,
 или ИД папки, ИД конкретного договора.
 
Проблемы в запросе: 
1. Проблема с огромным количеством логических чтений (6,5 млн), долгим выполнением (44.6 сек)
2. В плане самая большая стоимость - это Key lookup по таблице Свойства. 25 тысяч раз. Таблица свойств большая, в ней больше 2 млн записей.

Шаги оптимизации:
1. Sql говорит об отсутствующем индексе на таблицу Свойства. Действительно в выборках часто используется поиск по полям: Параметры-Договор, Виды-Параметры, ДатНач, ДатКнц, 
   а индекса такого нет. Изменила существующий индекс, добавив туда нужные поля. Значение, Примечание, Знач2 добавила в инклуд. Количество логических чтений упало до 2 млн 751
2. Попробовала вынеси функцию в Cte, стало логических чтений меньше, но появились физические чтения
3. Стала использовать функцию stack.contracts, которая вытаскивает все необходимы данные с договора и с классификаторов, но выполняется тоже с иерархии, что позволило вынести эту часть в cte,
   логических чтений стало 1 млн 882, время выполнения 26 сек., физические чтения никуда не делись...
4. Попробовала использовать вместо Cte временные таблицы, навесила на них индекс и УРА! логических чтений 654 551, физических чтений нет,
   время выполнения 26 сек, из них 23 сек и 477 576 чтений приходится на фукнцию stack.calc_contracts_accs(@dogs,@d1).
5. Вторую часть запроса даже не стала трогать - там выводится всего 6 строк, выполняется 6 мсек, чтений 261.